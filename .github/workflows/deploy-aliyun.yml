name: Add Aliyun 自动部署工作流程

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ① Debug：验证 secrets 注入 + 免密 ssh 成功（必须看到 OK）
      - name: SSH debug (ensure key works)
        shell: bash
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail

          # 防呆：host 为空/被填成字面量 SSH_HOST 时，回退到服务器公网 IP
          if [ -z "${SSH_HOST:-}" ] || [ "${SSH_HOST}" = "SSH_HOST" ]; then
            SSH_HOST="60.205.93.8"
          fi

          SSH_PORT=22

          echo "Using SSH_USER=${SSH_USER}"
          echo "Using SSH_HOST=${SSH_HOST}"
          echo "Using SSH_PORT=${SSH_PORT}"

          mkdir -p ~/.ssh
          printf '%s' "${SSH_PRIVATE_KEY}" | tr -d '\r' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # 打印私钥指纹（确认就是你那把 zfiZ...）
          ssh-keygen -lf ~/.ssh/id_ed25519

          ssh-keyscan -p "${SSH_PORT}" "${SSH_HOST}" >> ~/.ssh/known_hosts

          ssh -i ~/.ssh/id_ed25519 \
            -o IdentitiesOnly=yes \
            -o PasswordAuthentication=no \
            -p "${SSH_PORT}" \
            "${SSH_USER}@${SSH_HOST}" "echo OK"

      # ② 部署：先占位，等 debug OK 后你再把 script 换成真实部署命令
      - name: Deploy via SSH (appleboy)
        uses: appleboy/ssh-action@v1.2.0
        with:
          # 这里也建议直接用 IP，避免 DNS 抖动/误填
          host: 60.205.93.8
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            echo "Connected as: $(whoami)"
            echo "deploy placeholder"
